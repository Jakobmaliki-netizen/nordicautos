<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Biler til Supabase</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .config-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
        input[type="text"] { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Import Biler til Supabase</h1>
    
    <div class="info">
        <strong>Form√•l:</strong> Import biler fra cars.json til Supabase database.
    </div>

    <div class="config-section">
        <h3>Supabase Konfiguration</h3>
        <p>Indtast dine Supabase credentials (find dem i dit Supabase dashboard under Settings > API):</p>
        
        <label>Supabase URL:</label>
        <input type="text" id="supabaseUrl" placeholder="https://your-project-ref.supabase.co" />
        
        <label>Supabase Anon Key:</label>
        <input type="text" id="supabaseKey" placeholder="Din anon key fra Supabase dashboard" />
        
        <button onclick="updateSupabaseConfig()">Opdater Konfiguration</button>
    </div>
    
    <div id="status"></div>
    
    <div>
        <button id="checkSupabase" onclick="checkSupabaseStatus()">Tjek Supabase Status</button>
        <button id="createTable" onclick="createCarsTable()" disabled>Opret Cars Tabel</button>
        <button id="importCars" onclick="importCarsToSupabase()" disabled>Import Biler til Supabase</button>
        <button id="viewCars" onclick="viewCurrentCars()">Se Nuv√¶rende Biler</button>
        <button id="clearSupabase" onclick="clearSupabaseData()">Ryd Supabase Data</button>
    </div>
    
    <div id="results"></div>
    
    <script src="supabase-config.js"></script>
    <script>
        let supabaseReady = false;
        
        // Wait for Supabase to initialize
        document.addEventListener('DOMContentLoaded', async () => {
            showStatus('Klar til Supabase konfiguration...', 'info');
        });
        
        function updateSupabaseConfig() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                showStatus('‚ùå Indtast b√•de URL og Anon Key', 'error');
                return;
            }
            
            // Update the global config
            supabaseConfig.url = url;
            supabaseConfig.anonKey = key;
            
            showStatus('‚úÖ Supabase konfiguration opdateret!', 'success');
            document.getElementById('checkSupabase').disabled = false;
        }
        
        async function checkSupabaseStatus() {
            try {
                if (window.supabaseCarManager) {
                    const isReady = await window.supabaseCarManager.initialize();
                    
                    if (isReady) {
                        showStatus('‚úÖ Supabase er klar og forbundet!', 'success');
                        document.getElementById('createTable').disabled = false;
                        document.getElementById('importCars').disabled = false;
                        supabaseReady = true;
                        
                        // Show current car count
                        const cars = await window.supabaseCarManager.getCars();
                        showStatus(`üìä Supabase indeholder ${cars.length} biler`, 'info');
                    } else {
                        showStatus('‚ö†Ô∏è Supabase bruger localStorage fallback mode', 'error');
                        document.getElementById('importCars').disabled = false;
                        supabaseReady = false;
                    }
                } else {
                    showStatus('‚ùå Supabase Car Manager ikke fundet', 'error');
                }
            } catch (error) {
                showStatus('‚ùå Fejl ved tjek af Supabase: ' + error.message, 'error');
            }
        }
        
        async function createCarsTable() {
            try {
                showStatus('üîß Opretter cars tabel i Supabase...', 'info');
                
                // Import Supabase client directly
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                const supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);
                
                // Create the cars table using SQL
                const { data, error } = await supabase.rpc('create_cars_table');
                
                if (error) {
                    // Try alternative approach - create via SQL
                    showStatus('üìù Tabel eksisterer muligvis allerede eller skal oprettes manuelt', 'info');
                    showStatus('üí° G√• til Supabase Dashboard > SQL Editor og k√∏r f√∏lgende SQL:', 'info');
                    
                    const sqlQuery = `
CREATE TABLE IF NOT EXISTS cars (
    id BIGINT PRIMARY KEY,
    brand TEXT NOT NULL,
    model TEXT NOT NULL,
    variant TEXT,
    year INTEGER NOT NULL,
    mileage INTEGER NOT NULL,
    price INTEGER NOT NULL,
    "fuelType" TEXT NOT NULL,
    "bodyType" TEXT,
    horsepower INTEGER,
    images JSONB DEFAULT '[]'::jsonb,
    features JSONB DEFAULT '[]'::jsonb,
    description TEXT,
    status TEXT DEFAULT 'available',
    "isNew" BOOLEAN DEFAULT false,
    specifications JSONB DEFAULT '{}'::jsonb,
    history JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE cars ENABLE ROW LEVEL SECURITY;

-- Create policy to allow all operations (adjust as needed)
CREATE POLICY "Allow all operations on cars" ON cars FOR ALL USING (true);

-- Create storage bucket for car images
INSERT INTO storage.buckets (id, name, public) 
VALUES ('car-images', 'car-images', true) 
ON CONFLICT (id) DO NOTHING;

-- Create policy for storage bucket
CREATE POLICY "Allow all operations on car images" ON storage.objects 
FOR ALL USING (bucket_id = 'car-images');
                    `;
                    
                    document.getElementById('results').innerHTML = `
                        <h3>SQL til at oprette cars tabel:</h3>
                        <pre>${sqlQuery}</pre>
                        <p>Kopier denne SQL og k√∏r den i Supabase Dashboard > SQL Editor</p>
                    `;
                } else {
                    showStatus('‚úÖ Cars tabel oprettet succesfuldt!', 'success');
                }
                
            } catch (error) {
                showStatus('‚ùå Fejl ved oprettelse af tabel: ' + error.message, 'error');
            }
        }
        
        async function importCarsToSupabase() {
            try {
                showStatus('üì• Henter bil data fra cars.json...', 'info');
                
                // Fetch cars from JSON file
                const response = await fetch('assets/data/cars.json');
                if (!response.ok) {
                    throw new Error('Kunne ikke hente cars.json fil');
                }
                
                const carsData = await response.json();
                showStatus(`üìã Fandt ${carsData.length} biler i JSON filen`, 'info');
                
                // Import each car
                let successCount = 0;
                let errorCount = 0;
                
                for (const car of carsData) {
                    try {
                        showStatus(`üíæ Importerer: ${car.brand} ${car.model}...`, 'info');
                        
                        if (window.supabaseCarManager) {
                            const result = await window.supabaseCarManager.saveCar(car);
                            if (result) {
                                successCount++;
                                showStatus(`‚úÖ Importeret: ${car.brand} ${car.model}`, 'success');
                            } else {
                                errorCount++;
                                showStatus(`‚ùå Fejl ved import af: ${car.brand} ${car.model}`, 'error');
                            }
                        } else {
                            throw new Error('Supabase Car Manager ikke tilg√¶ngelig');
                        }
                        
                        // Small delay to avoid overwhelming Supabase
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        errorCount++;
                        showStatus(`‚ùå Fejl ved import af ${car.brand} ${car.model}: ${error.message}`, 'error');
                    }
                }
                
                showStatus(`üéâ Import f√¶rdig! ${successCount} succesfulde, ${errorCount} fejl`, 
                          errorCount > 0 ? 'error' : 'success');
                
                // Refresh car count
                setTimeout(checkSupabaseStatus, 1000);
                
            } catch (error) {
                showStatus('‚ùå Fejl ved import: ' + error.message, 'error');
            }
        }
        
        async function viewCurrentCars() {
            try {
                if (window.supabaseCarManager) {
                    const cars = await window.supabaseCarManager.getCars();
                    
                    const resultsDiv = document.getElementById('results');
                    resultsDiv.innerHTML = `
                        <h3>Nuv√¶rende Biler i Supabase (${cars.length})</h3>
                        <pre>${JSON.stringify(cars, null, 2)}</pre>
                    `;
                } else {
                    showStatus('‚ùå Supabase Car Manager ikke tilg√¶ngelig', 'error');
                }
            } catch (error) {
                showStatus('‚ùå Fejl ved hentning af biler: ' + error.message, 'error');
            }
        }
        
        async function clearSupabaseData() {
            if (!confirm('Er du sikker p√• at du vil slette ALLE biler fra Supabase?')) {
                return;
            }
            
            try {
                if (window.supabaseCarManager) {
                    const cars = await window.supabaseCarManager.getCars();
                    
                    let deletedCount = 0;
                    for (const car of cars) {
                        const result = await window.supabaseCarManager.deleteCar(car.id);
                        if (result) {
                            deletedCount++;
                            showStatus(`üóëÔ∏è Slettet: ${car.brand} ${car.model}`, 'info');
                        }
                        
                        // Small delay
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                    
                    showStatus(`üßπ Slettet ${deletedCount} biler fra Supabase`, 'success');
                    setTimeout(checkSupabaseStatus, 1000);
                } else {
                    showStatus('‚ùå Supabase Car Manager ikke tilg√¶ngelig', 'error');
                }
            } catch (error) {
                showStatus('‚ùå Fejl ved sletning: ' + error.message, 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            const statusElement = document.createElement('div');
            statusElement.className = `status ${type}`;
            statusElement.textContent = new Date().toLocaleTimeString() + ': ' + message;
            statusDiv.appendChild(statusElement);
            
            // Auto-scroll to bottom
            statusDiv.scrollTop = statusDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    </script>
</body>
</html>