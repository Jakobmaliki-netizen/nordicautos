<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Test Real-Time Fix - Nordic Autos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-fallback { background-color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Real-Time Update System Test</h1>
        
        <!-- Connection Status -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Connection Status</h2>
            <div id="connection-status" class="space-y-2">
                <div>RealTimeManager: <span id="rtm-status" class="font-mono">Not initialized</span></div>
                <div>CrossTabBridge: <span id="ctb-status" class="font-mono">Not initialized</span></div>
                <div>Supabase: <span id="supabase-status" class="font-mono">Not initialized</span></div>
            </div>
        </div>
        
        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="space-x-4">
                <button id="test-cross-tab" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Cross-Tab Message
                </button>
                <button id="test-car-update" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Simulate Car Update
                </button>
                <button id="test-connection" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Test Connection
                </button>
            </div>
        </div>
        
        <!-- Event Log -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Event Log</h2>
            <div id="event-log" class="bg-gray-50 p-4 rounded h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">Waiting for events...</div>
            </div>
            <button id="clear-log" class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                Clear Log
            </button>
        </div>
    </div>

    <!-- Load the real-time system -->
    <script src="supabase-config.js"></script>
    <script src="assets/js/cross-tab-bridge.js"></script>
    <script src="assets/js/real-time-manager.js"></script>
    
    <script>
        let realTimeManager = null;
        let crossTabBridge = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
            
            const entry = document.createElement('div');
            entry.className = color;
            entry.textContent = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(component, status, isOnline = null) {
            const statusEl = document.getElementById(`${component}-status`);
            if (statusEl) {
                statusEl.textContent = status;
                
                // Add status indicator
                const indicator = document.createElement('span');
                indicator.className = 'status-indicator ' + (
                    isOnline === true ? 'status-online' :
                    isOnline === false ? 'status-offline' :
                    'status-fallback'
                );
                statusEl.parentNode.insertBefore(indicator, statusEl);
            }
        }
        
        async function initializeSystem() {
            log('ðŸš€ Initializing real-time system...');
            
            try {
                // Wait for dependencies
                await new Promise(resolve => {
                    const checkDeps = () => {
                        if (window.RealTimeManager && window.CrossTabBridge && window.supabaseCarManager) {
                            resolve();
                        } else {
                            setTimeout(checkDeps, 100);
                        }
                    };
                    checkDeps();
                });
                
                // Initialize CrossTabBridge
                crossTabBridge = new CrossTabBridge();
                updateStatus('ctb', 'Initialized', true);
                log('âœ… CrossTabBridge initialized');
                
                // Subscribe to cross-tab events
                crossTabBridge.subscribe('test_message', (event) => {
                    log(`ðŸ“¨ Cross-tab message received: ${JSON.stringify(event.data)}`);
                });
                
                // Initialize RealTimeManager
                realTimeManager = new RealTimeManager();
                const rtmSuccess = await realTimeManager.initialize();
                
                updateStatus('rtm', rtmSuccess ? 'Connected' : 'Fallback Mode', rtmSuccess);
                log(rtmSuccess ? 'âœ… RealTimeManager connected' : 'âš ï¸ RealTimeManager in fallback mode');
                
                // Subscribe to real-time updates
                realTimeManager.subscribeToCarUpdates((event) => {
                    log(`ðŸ”„ Real-time update: ${event.type} - ${JSON.stringify(event.data)}`);
                });
                
                // Check Supabase status
                const supabaseStatus = realTimeManager.getConnectionStatus();
                updateStatus('supabase', 
                    supabaseStatus.supabaseConnected ? 'Connected' : 'Offline',
                    supabaseStatus.supabaseConnected
                );
                
                log('ðŸŽ‰ System initialization complete!');
                
            } catch (error) {
                log(`âŒ Initialization error: ${error.message}`, 'error');
            }
        }
        
        // Event handlers
        document.getElementById('test-cross-tab').addEventListener('click', () => {
            if (crossTabBridge) {
                const testData = { message: 'Hello from tab!', timestamp: Date.now() };
                crossTabBridge.broadcast('test_message', testData);
                log(`ðŸ“¡ Broadcast test message: ${JSON.stringify(testData)}`);
            } else {
                log('âŒ CrossTabBridge not initialized', 'error');
            }
        });
        
        document.getElementById('test-car-update').addEventListener('click', () => {
            if (realTimeManager) {
                const testUpdate = {
                    carId: 'test-car-123',
                    carData: { brand: 'Test', model: 'Updated Model', price: 500000 },
                    source: 'test',
                    timestamp: Date.now()
                };
                
                // Simulate a car update
                realTimeManager.notifySubscribers('car_updated', testUpdate);
                log(`ðŸš— Simulated car update: ${JSON.stringify(testUpdate)}`);
            } else {
                log('âŒ RealTimeManager not initialized', 'error');
            }
        });
        
        document.getElementById('test-connection').addEventListener('click', () => {
            if (realTimeManager) {
                const status = realTimeManager.getConnectionStatus();
                log(`ðŸ“Š Connection status: ${JSON.stringify(status, null, 2)}`);
            } else {
                log('âŒ RealTimeManager not initialized', 'error');
            }
        });
        
        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('event-log').innerHTML = '<div class="text-gray-500">Log cleared...</div>';
        });
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>